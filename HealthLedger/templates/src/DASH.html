<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employee Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">Employee Management Dashboard</h1>
      <div>
        <button id="refreshBtn" class="px-3 py-2 bg-blue-600 rounded">Refresh</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm text-gray-400">Total Employees</p>
        <p id="total_records" class="text-2xl font-bold">--</p>
      </div>
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm text-gray-400">Total Salary (₹)</p>
        <p id="total_salary" class="text-2xl font-bold">--</p>
      </div>
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm text-gray-400">Total Bonus (₹)</p>
        <p id="total_bonus" class="text-2xl font-bold">--</p>
      </div>
      <div class="bg-gray-800 p-4 rounded shadow">
        <p class="text-sm text-gray-400">Average Salary (₹)</p>
        <p id="avg_salary" class="text-2xl font-bold">--</p>
      </div>
    </div>

    <!-- Chart + Table -->
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Salary vs Bonus (Top 20)</h2>
        <canvas id="salaryChart" height="220"></canvas>
      </div>

      <div class="bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Matched Employees (latest)</h2>
        <div class="overflow-auto max-h-96">
          <table class="min-w-full divide-y divide-gray-700 text-sm">
            <thead>
              <tr>
                <th class="px-3 py-2 text-left">EMP_ID</th>
                <th class="px-3 py-2 text-left">NAME</th>
                <th class="px-3 py-2 text-right">SALARY</th>
                <th class="px-3 py-2 text-left">DEPARTMENT</th>
                <th class="px-3 py-2 text-right">BONUS</th>
              </tr>
            </thead>
            <tbody id="matchedBody" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-6 bg-gray-800 p-4 rounded shadow">
      <h3 class="text-lg font-semibold">Recent Activity</h3>
      <div id="activityList" class="mt-3 space-y-3 text-sm text-gray-300"></div>
    </div>
  </div>

<script>
  const API_STATS = "/api/get_stats";
  const API_MATCHED = "/api/matched";
  const API_ACTIVITY = "/api/recent-activity";

  let salaryChart;

  async function loadStats() {
    try {
      const res = await fetch(API_STATS);
      const data = await res.json();
      document.getElementById("total_records").textContent = data.total_records;
      document.getElementById("total_salary").textContent = `₹${Number(data.total_salary).toLocaleString()}`;
      document.getElementById("total_bonus").textContent = `₹${Number(data.total_bonus).toLocaleString()}`;
      document.getElementById("avg_salary").textContent = `₹${Number(data.avg_salary).toLocaleString()}`;
    } catch (err) {
      console.error("Error loading stats", err);
    }
  }

  async function loadMatchedAndRender() {
    try {
      const res = await fetch(API_MATCHED);
      const rows = await res.json();
      // show latest 50 (or fewer)
      const slice = rows.slice(0, 50);

      // Populate table
      const tbody = document.getElementById("matchedBody");
      tbody.innerHTML = "";
      slice.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${r.EMP_ID ?? ""}</td>
          <td class="px-3 py-2">${r.NAME ?? ""}</td>
          <td class="px-3 py-2 text-right">${r.SALARY ?? ""}</td>
          <td class="px-3 py-2">${r.DEPARTMENT ?? ""}</td>
          <td class="px-3 py-2 text-right">${r.BONUS ?? ""}</td>
        `;
        tbody.appendChild(tr);
      });

      // Chart data (top 20 by salary)
      const sorted = [...rows].sort((a,b) => (b.SALARY||0) - (a.SALARY||0)).slice(0,20);
      const labels = sorted.map(r => r.EMP_ID);
      const salaryData = sorted.map(r => Number(r.SALARY) || 0);
      const bonusData  = sorted.map(r => Number(r.BONUS)  || 0);

      const ctx = document.getElementById("salaryChart").getContext("2d");
      if (salaryChart) salaryChart.destroy();
      salaryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Salary', data: salaryData, backgroundColor: 'rgba(59,130,246,0.8)' },
            { label: 'Bonus',  data: bonusData,  backgroundColor: 'rgba(16,185,129,0.8)' }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            x: { ticks: { color: '#fff' } },
            y: { ticks: { color: '#fff' } }
          }
        }
      });

    } catch (err) {
      console.error("Error loading matched", err);
    }
  }

  async function loadActivity() {
    try {
      const res = await fetch(API_ACTIVITY);
      const data = await res.json();
      const box = document.getElementById("activityList");
      box.innerHTML = "";
      (data.activities || []).forEach((a) => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-700 rounded";
        div.innerHTML = `<div class="text-sm">${a.log_name}</div><div class="text-xs text-gray-400">${a.log_desc}</div>`;
        box.appendChild(div);
      });
    } catch (err) {
      console.error("Error loading activity", err);
    }
  }

  async function refreshAll() {
    await loadStats();
    await loadMatchedAndRender();
    await loadActivity();
  }

  document.getElementById("refreshBtn").addEventListener("click", refreshAll);

  // initial load
  refreshAll();
</script>
</body>
</html>
